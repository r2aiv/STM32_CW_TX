/*

	LIBCW.C - CW Radio Impleentation library for STM32
	(c) Denis S. Sovkov 03/2017

*/

#include <string.h>
#include "stm32f4xx_hal.h"
#include "libcw.h"

extern TIM_HandleTypeDef htim2;

// CW Alphabet: every sign is terminated by 0xAA

unsigned char A[]={0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char B[]={0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xAA};
unsigned char C[]={0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xAA};
unsigned char D[]={0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0xAA};
unsigned char E[]={0xFF,0xAA};
unsigned char F[]={0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xAA};
unsigned char G[]={0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xAA};
unsigned char H[]={0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xAA};
unsigned char I[]={0xFF,0x00,0xFF,0xAA};
unsigned char J[]={0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char K[]={0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char L[]={0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0xAA};
unsigned char M[]={0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char N[]={0xFF,0xFF,0xFF,0x00,0xFF,0xAA};
unsigned char O[]={0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char P[]={0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xAA};
unsigned char Q[]={0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char R[]={0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xAA};
unsigned char S[]={0xFF,0x00,0xFF,0x00,0xFF,0xAA};
unsigned char T[]={0xFF,0xFF,0xFF,0xAA};
unsigned char U[]={0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char V[]={0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char W[]={0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char X[]={0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char Y[]={0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char Z[]={0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0xAA};
unsigned char SP[]={0x00,0x00,0x00,0xAA}; // Space between words
unsigned char ONE[]={0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char TWO[]={0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char THREE[]={0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char FOUR[]={0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};
unsigned char FIVE[]={0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xAA};
unsigned char SIX[]={0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xAA};
unsigned char SEVEN[]={0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xAA};
unsigned char EIGHT[]={0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0x00,0xFF,0xAA};
unsigned char NINE[]={0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xAA};
unsigned char ZERO[]={0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0xAA};

// CopyCharArray - копирует массив char и возвращает 
// кол-во скопированных байтов
int CopyCharArray(uint8_t *Buffer,uint8_t *Array)
{
	int ArrayPos=0;
	memset(Buffer,0,25);
		
	while(*(Array+ArrayPos) != 0xAA)
	{
		*(Buffer+ArrayPos)=*(Array+ArrayPos);
		ArrayPos++;
	}
	*(Buffer+ArrayPos+1)=0xAA; // Add terminating symbol
	return ArrayPos+1;
}

void SendChar(unsigned char Char)
{
	unsigned char TempBuffer[25];
	int CharSize=0;
	int CharCnt=0;
	
	switch(Char)
	{
		case 'A':
		case 'a':
			CharSize=CopyCharArray(TempBuffer,A);			
			break;
		case 'B':
		case 'b':
			CharSize=CopyCharArray(TempBuffer,B);
		  break;
		case 'C':
		case 'c':
			CharSize=CopyCharArray(TempBuffer,C);
		  break;
		case 'D':
		case 'd':
			CharSize=CopyCharArray(TempBuffer,D);
		  break;
		case 'E':
		case 'e':
			CharSize=CopyCharArray(TempBuffer,E);
		  break;
		case 'F':
		case 'f':
			CharSize=CopyCharArray(TempBuffer,F);
		break;
		case 'G':
		case 'g':
			CharSize=CopyCharArray(TempBuffer,G);
		break;
		case 'H':
		case 'h':
			CharSize=CopyCharArray(TempBuffer,H);
		break;
		case 'I':
		case 'i':
			CharSize=CopyCharArray(TempBuffer,I);
		break;
		case 'J':
		case 'j':
			CharSize=CopyCharArray(TempBuffer,J);
		break;
		case 'K':
		case 'k':
			CharSize=CopyCharArray(TempBuffer,K);
		break;
		case 'L':
		case 'l':
			CharSize=CopyCharArray(TempBuffer,L);
		break;
		case 'M':
		case 'm':
			CharSize=CopyCharArray(TempBuffer,M);
		break;
		case 'N':
		case 'n':
			CharSize=CopyCharArray(TempBuffer,N);
		break;
		case 'O':
		case 'o':
			CharSize=CopyCharArray(TempBuffer,O);
		break;
		case 'P':
		case 'p':
			CharSize=CopyCharArray(TempBuffer,P);
		break;
		case 'Q':
		case 'q':
			CharSize=CopyCharArray(TempBuffer,Q);
		break;
		case 'R':
		case 'r':
			CharSize=CopyCharArray(TempBuffer,R);
		break;
		case 'S':
		case 's':
			CharSize=CopyCharArray(TempBuffer,S);
		break;
		case 'T':
		case 't':
			CharSize=CopyCharArray(TempBuffer,T);
		break;
		case 'U':
		case 'u':
			CharSize=CopyCharArray(TempBuffer,U);
		break;
		case 'V':
		case 'v':
			CharSize=CopyCharArray(TempBuffer,V);
		break;
		case 'W':
		case 'w':
			CharSize=CopyCharArray(TempBuffer,W);
		break;
		case 'X':
		case 'x':
			CharSize=CopyCharArray(TempBuffer,X);
		break;
		case 'Y':
		case 'y':
			CharSize=CopyCharArray(TempBuffer,Y);
		break;
		case 'Z':
		case 'z':
			CharSize=CopyCharArray(TempBuffer,Z);
		break;	
    case ' ':
			CharSize=CopyCharArray(TempBuffer,SP);
		break;
		
		case '1':
			CharSize=CopyCharArray(TempBuffer,ONE);
		break;
		case '2':
			CharSize=CopyCharArray(TempBuffer,TWO);
		break;
		case '3':
			CharSize=CopyCharArray(TempBuffer,THREE);
		break;
		case '4':
			CharSize=CopyCharArray(TempBuffer,FOUR);
		break;
		case '5':
			CharSize=CopyCharArray(TempBuffer,FIVE);
		break;
		case '6':
			CharSize=CopyCharArray(TempBuffer,SIX);
		break;
		case '7':
			CharSize=CopyCharArray(TempBuffer,SEVEN);
		break;
		case '8':
			CharSize=CopyCharArray(TempBuffer,EIGHT);
		break;
		case '9':
			CharSize=CopyCharArray(TempBuffer,NINE);
		break;
		case '0':
			CharSize=CopyCharArray(TempBuffer,ZERO);
		break;		
		
		default:
		break;		
	} // End Switch
	
	for(CharCnt=0;CharCnt<CharSize;CharCnt++)
	{
		switch(TempBuffer[CharCnt])	
		{
			case 0x00:
					HAL_TIM_OC_Stop(&htim2,TIM_CHANNEL_1);
				  HAL_GPIO_WritePin(GPIOD,GPIO_PIN_13,GPIO_PIN_RESET);
			break;
			case 0xFF:
					HAL_TIM_OC_Start(&htim2,TIM_CHANNEL_1);
				  HAL_GPIO_WritePin(GPIOD,GPIO_PIN_13,GPIO_PIN_SET);
			break;
			default:
			break;						  
		}
	 //HAL_TIM_OC_Stop(&htim2,TIM_CHANNEL_1);	
   HAL_Delay(WORK_TIME); // Время работы (паузы) таймера		
	}
	HAL_Delay(WORK_TIME); // Пауза между символами
}

void SendString(char *String)
{
	int CharCnt=0;
	for(CharCnt=0;CharCnt<strlen(String);CharCnt++)
	{
		SendChar(String[CharCnt]);
	}
	
}
